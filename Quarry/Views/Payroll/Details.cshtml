@model QuarryManagementSystem.ViewModels.PayrollDetailsViewModel
@{
    ViewData["Title"] = "Payroll Details";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Payroll Details</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index","Dashboard")">Home</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Index","Payroll")">Payroll</a></li>
                    <li class="breadcrumb-item active">Details</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger">@TempData["Error"]</div>
        }
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success">@TempData["Success"]</div>
        }

        <div class="card card-outline card-primary">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    Run @Model.PayrollRun.RunNumber (@Model.PayrollRun.PaymentMonth.ToString("MMMM yyyy"))
                </h3>
                <div>
                    <span class="badge badge-@(Model.PayrollRun.Status == "Processed" ? "info" : Model.PayrollRun.Status == "Paid" ? "success" : "secondary")">
                        @Model.PayrollRun.Status
                    </span>

                    @if (Model.CanProcess)
                    {
                        <form asp-action="Process" asp-controller="Payroll" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.PayrollRun.Id" />
                            <button type="submit" class="btn btn-sm btn-warning">
                                <i class="fas fa-cogs"></i> Process
                            </button>
                        </form>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-warning" disabled>
                            <i class="fas fa-cogs"></i> Process
                        </button>
                    }

                    @if (Model.BankPaymentFileReady)
                    {
                        <a class="btn btn-sm btn-success" href="@Url.Action("GenerateBankFile","Payroll", new { id = Model.PayrollRun.Id })">
                            <i class="fas fa-file-download"></i> Bank File
                        </a>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-success" disabled>
                            <i class="fas fa-file-download"></i> Bank File
                        </button>
                    }

                    <a class="btn btn-sm btn-secondary" href="@Url.Action("Index","Payroll")">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </div>
            </div>
            <div class="card-body">

                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="info-box">
                            <span class="info-box-icon bg-info"><i class="fas fa-users"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Employees</span>
                                <span class="info-box-number">@Model.PayrollRun.TotalEmployees</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-box">
                            <span class="info-box-icon bg-primary"><i class="fas fa-coins"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Gross Pay</span>
                                <span class="info-box-number">@Model.PayrollRun.GrossPay.ToString("C")</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-box">
                            <span class="info-box-icon bg-success"><i class="fas fa-money-bill-wave"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Net Pay</span>
                                <span class="info-box-number">@Model.PayrollRun.NetPay.ToString("C")</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-box">
                            <span class="info-box-icon bg-warning"><i class="fas fa-hand-holding-usd"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">Employer Contributions</span>
                                <span class="info-box-number">@Model.TotalEmployerContributions.ToString("C")</span>
                            </div>
                        </div>
                    </div>
                </div>

                <h5 class="mb-2">Employee Salaries</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Employee Code</th>
                                <th>Name</th>
                                <th class="text-right">Basic</th>
                                <th class="text-right">Housing</th>
                                <th class="text-right">Transport</th>
                                <th class="text-right">Gross</th>
                                <th class="text-right">PAYE</th>
                                <th class="text-right">Pension (Emp.)</th>
                                <th class="text-right">NHIS</th>
                                <th class="text-right">Net</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                        @if (Model.PayrollRun.EmployeeSalaries != null && Model.PayrollRun.EmployeeSalaries.Any())
                        {
                            foreach (var s in Model.PayrollRun.EmployeeSalaries.OrderBy(e => e.Employee.FullName))
                            {
                                <tr>
                                    <td>@s.Employee.EmployeeCode</td>
                                    <td>@s.Employee.FullName</td>
                                    <td class="text-right">@s.BasicSalary.ToString("N2")</td>
                                    <td class="text-right">@s.HousingAllowance.ToString("N2")</td>
                                    <td class="text-right">@s.TransportAllowance.ToString("N2")</td>
                                    <td class="text-right">@s.GrossPay.ToString("N2")</td>
                                    <td class="text-right">@s.PAYE.ToString("N2")</td>
                                    <td class="text-right">@s.PensionEmployee.ToString("N2")</td>
                                    <td class="text-right">@s.NHIS.ToString("N2")</td>
                                    <td class="text-right">@s.NetPay.ToString("N2")</td>
                                    <td>@s.PaymentStatus</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="11" class="text-center text-muted p-4">No salary lines found for this payroll.</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <p class="text-muted mb-0">
                        Processed By: @(Model.PayrollRun.ProcessedBy ?? "—") |
                        Processed At: @(Model.PayrollRun.ProcessedAt?.ToString("yyyy-MM-dd HH:mm") ?? "—")
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>